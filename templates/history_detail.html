<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>body { font-family: 'Prompt', sans-serif; }</style>
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
            <h4>
                <i class="fas fa-book"></i> ‡∏ß‡∏¥‡∏ä‡∏≤: {{ session['subject_id'] }} 
                <small class="text-muted">({{ session['created_at'] }})</small>
            </h4>
            <div class="d-flex gap-2">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addManualModal">
                    <i class="fas fa-user-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
                </button>
                <a href="/export_history/{{ session['id'] }}" class="btn btn-success">
                    <i class="fas fa-file-excel"></i> Export
                </a>
                <a href="/history" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
                </a>
            </div>
        </div>

        <div class="card shadow">
            <div class="card-body">
                <h5>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: <span class="text-success">{{ students|length }} ‡∏Ñ‡∏ô</span></h5>
                <hr>
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</th>
                                <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th> 
                                <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th>‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in students %}
                            <tr>
                                <td class="fw-bold">{{ student['student_id'] }}</td>
                                <td class="text-primary">{{ student['name'] if student['name'] else '-' }}</td>
                                <td>{{ student['check_in_time'] }}</td>
                                <td>
                                    {% if student['status'] == 'leave' %}
                                        <span class="badge bg-info text-dark">‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢/‡∏•‡∏≤‡∏Å‡∏¥‡∏à</span>
                                    {% elif student['status'] == 'late' %}
                                        <span class="badge bg-warning text-dark">‡∏°‡∏≤‡∏™‡∏≤‡∏¢</span>
                                    {% else %}
                                        <span class="badge bg-success">‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
                                    {% endif %}
                                </td>
                                <td><span class="badge bg-light text-dark border">{{ student['distance'] }}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if not students %}
                    <div class="alert alert-warning text-center">‡∏Ñ‡∏≤‡∏ö‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏•‡∏¢ (‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏∑‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠)</div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="modal fade" id="addManualModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-user-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á)</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="historyAddForm">
                        <div class="mb-3">
                            <label class="form-label fw-bold">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ *</label>
                            <input type="text" class="form-control" id="h_student_id" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                            <input type="text" class="form-control" id="h_name" placeholder="‡∏ñ‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Ñ‡∏¢‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏î‡∏∂‡∏á‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                            <select class="form-select" id="h_status">
                                <option value="present">‚úÖ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                                <option value="late">‚ö†Ô∏è ‡∏°‡∏≤‡∏™‡∏≤‡∏¢</option>
                                <option value="leave">üìù ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢/‡∏•‡∏≤‡∏Å‡∏¥‡∏à</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('historyAddForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

            const payload = {
                session_id: {{ session['id'] }},
                student_id: document.getElementById('h_student_id').value,
                name: document.getElementById('h_name').value,
                status: document.getElementById('h_status').value
            };

            fetch('/api/history_add_student', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', data.message, 'success').then(() => location.reload());
                } else {
                    Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', data.message, 'error');
                    btn.disabled = false;
                    btn.innerHTML = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                }
            });
        });
    </script>
</body>
</html>