<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Analytics</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Prompt', sans-serif; background-color: #f4f6f9; }
        .stat-card { transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-5px); }
        .risk-row { background-color: #ffebee; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark shadow-sm">
        <div class="container">
            <span class="navbar-brand fw-bold text-warning"><i class="fas fa-chart-line me-2"></i>Admin Analytics</span>
            <a href="/admin/logout" class="btn btn-outline-light btn-sm">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
        </div>
    </nav>

    <div class="container py-4">
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="card border-0 shadow-sm stat-card bg-primary text-white h-100">
                    <div class="card-body text-center">
                        <h1 class="fw-bold">{{ stats.total_sessions }}</h1>
                        <p>üìö ‡∏Ñ‡∏•‡∏≤‡∏™‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm stat-card bg-success text-white h-100">
                    <div class="card-body text-center">
                        <h1 class="fw-bold">{{ stats.total_checkins }}</h1>
                        <p>‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏ß‡∏° (‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm stat-card bg-info text-white h-100">
                    <div class="card-body text-center">
                        <h1 class="fw-bold">{{ stats.unique_students }}</h1>
                        <p>üë• ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm stat-card bg-danger text-white h-100">
                    <div class="card-body text-center">
                        <h1 class="fw-bold">{{ risk_students|length }}</h1>
                        <p>‚ö†Ô∏è ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏´‡∏°‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≠‡∏ö</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-8">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-white fw-bold"><i class="fas fa-chart-bar me-2"></i>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏•‡∏≤‡∏™ 7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
                    <div class="card-body">
                        <canvas id="attendanceChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-danger text-white fw-bold"><i class="fas fa-exclamation-triangle me-2"></i>‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (‡πÄ‡∏Ç‡πâ‡∏≤ < 80%)</div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
                            {% for st in risk_students %}
                            <div class="list-group-item risk-row">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1 fw-bold">{{ st.name }}</h6>
                                    <small class="text-danger fw-bold">{{ st.percent }}%</small>
                                </div>
                                <small class="text-muted">‡∏£‡∏´‡∏±‡∏™: {{ st.id }} (‡∏°‡∏≤ {{ st.attended }}/{{ st.total }})</small>
                            </div>
                            {% else %}
                            <div class="p-3 text-center text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm border-0">
            <div class="card-header bg-white">
                <ul class="nav nav-tabs card-header-tabs" id="adminTab" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active text-danger" id="fraud-tab" data-bs-toggle="tab" data-bs-target="#fraud" type="button">
                            <i class="fas fa-user-secret me-2"></i>‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÇ‡∏Å‡∏á IP
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="sessions-tab" data-bs-toggle="tab" data-bs-target="#sessions" type="button">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏≤‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="danger-tab" data-bs-toggle="tab" data-bs-target="#danger" type="button">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content">
                    
                    <div class="tab-pane fade show active" id="fraud">
                        <div class="alert alert-warning">
                            <i class="fas fa-info-circle me-2"></i> ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ IP Address ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ <b>‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏Ñ‡∏ô ‡πÉ‡∏ô‡∏Ñ‡∏•‡∏≤‡∏™‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô</b> (‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡∏ß‡πà‡∏≤‡∏ù‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡πÅ‡∏Å‡∏ô)
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>‡∏ß‡∏¥‡∏ä‡∏≤</th>
                                        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                        <th>IP Address ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏á‡∏™‡∏±‡∏¢</th>
                                        <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô (Dupes)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for log in cheating_logs %}
                                    <tr>
                                        <td class="fw-bold text-primary">{{ log.subject_id }}</td>
                                        <td>{{ log.created_at }}</td>
                                        <td class="font-monospace text-danger">{{ log.ip_address }}</td>
                                        <td><span class="badge bg-danger rounded-pill">{{ log.dup_count }} ‡∏Ñ‡∏ô</span></td>
                                    </tr>
                                    {% else %}
                                    <tr><td colspan="4" class="text-center text-muted py-3">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏ô‡πà‡∏≤‡∏™‡∏á‡∏™‡∏±‡∏¢</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="sessions">
                        <h5 class="mb-3">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h5>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr><th>ID</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏ß‡∏¥‡∏ä‡∏≤</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr>
                                </thead>
                                <tbody>
                                    {% for s in sessions %}
                                    <tr id="row-{{ s['id'] }}">
                                        <td>{{ s['id'] }}</td>
                                        <td>{{ s['created_at'] }}</td>
                                        <td class="fw-bold text-primary">{{ s['subject_id'] }}</td>
                                        <td>
                                            <a href="/history/{{ s['id'] }}" class="btn btn-sm btn-info text-white" target="_blank"><i class="fas fa-eye"></i></a>
                                            <button onclick="deleteSession({{ s['id'] }})" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="danger">
                        <div class="alert alert-danger d-flex justify-content-between align-items-center">
                            <div>
                                <strong>‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Factory Reset)</strong><br>
                                <small>‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà</small>
                            </div>
                            <button onclick="resetDatabase()" class="btn btn-danger shadow"><i class="fas fa-bomb me-2"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏î‡πâ‡∏ß‡∏¢ Chart.js
        const ctx = document.getElementById('attendanceChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: {{ chart_labels | safe }},
                datasets: [{
                    label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏•‡∏≤‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î',
                    data: {{ chart_values | safe }},
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
            }
        });

        function deleteSession(id) {
            if(confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏•‡∏≤‡∏™‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                fetch('/api/delete_session', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id: id })
                }).then(res => res.json()).then(data => {
                    if(data.status === 'success') document.getElementById('row-' + id).remove();
                });
            }
        }

        function resetDatabase() {
            if(prompt("‡∏û‡∏¥‡∏°‡∏û‡πå 'DELETE' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô:") === 'DELETE') {
                fetch('/api/admin/reset_database', { method: 'POST' })
                .then(res => res.json()).then(data => { alert(data.message); location.reload(); });
            }
        }
    </script>
</body>
</html>